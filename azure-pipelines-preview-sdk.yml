# actionscore/actions preview-kit

trigger: none

pr : none

schedules:
- cron: "00 06 * * Tue-Sat"
  displayName: M-F 11:00PM PST daily build
  branches:
    include:
    - master

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: DownloadBuildArtifacts@0
  displayName: 'Download Actions CLI Binaries'
  inputs:
    buildType: 'specific'
    project: 'bf44e908-7feb-4695-9882-2ec74aa9f834'
    pipeline: '6'
    buildVersionToDownload: 'latest'
    tags: 'release'
    downloadType: 'single'
    artifactName: 'drop'
    downloadPath: '$(System.ArtifactsDirectory)/release'
- task: DownloadBuildArtifacts@0
  displayName: 'Download Specs'
  inputs:
    buildType: 'specific'
    project: 'bf44e908-7feb-4695-9882-2ec74aa9f834'
    pipeline: '15'
    buildVersionToDownload: 'latestFromBranch'
    branchName: 'refs/heads/master'
    downloadType: 'single'
    artifactName: 'drop'
    downloadPath: '$(System.ArtifactsDirectory)/spec_drop'

- task: DownloadBuildArtifacts@0
  displayName: 'Download cs-sdk'
  continueOnError: true
  inputs:
    buildType: 'specific'
    project: 'bf44e908-7feb-4695-9882-2ec74aa9f834'
    pipeline: '16'
    buildVersionToDownload: 'latest'
    tags: 'release'
    downloadType: 'single'
    artifactName: 'release_drop'
    downloadPath: '$(System.ArtifactsDirectory)/cs-sdk'
- task: Bash@3
  displayName: 'Git clone preview repo'
  inputs:
    targetType: 'inline'
    script: |
      cd ..
      git config --global user.email "actionsvt@service.microsoft.com"
      git config --global user.name "Actions Release"

      git clone https://$(PREVIEW_GITHUB_USERNAME):$(PREVIEW_GITHUB_SECRET)@github.com/actionscore/previewkit.git
    workingDirectory: '$(Build.SourcesDirectory)'
- task: Bash@3
  displayName: 'Git clone actions/cli repo'
  inputs:
    targetType: 'inline'
    script: |
      cd ..
      git clone https://$(PREVIEW_GITHUB_USERNAME):$(PREVIEW_GITHUB_SECRET)@github.com/actionscore/cli.git
    workingDirectory: '$(Build.SourcesDirectory)'
- task: Bash@3
  displayName: 'Copy Preview Kit contents to preview repo'
  inputs:
    targetType: 'inline'
    script: |
      pushd ../previewkit
      rm -rf samples docs release_notes
      rm -f LICENSE README.md
      popd
      
      cp LICENSE ../previewkit/
      cp -R samples ../previewkit/
      cp -R docs ../previewkit/
      mv ../previewkit/docs/preview/README.md ../previewkit/
      mkdir ../previewkit/docs/cli
      mv ../cli/docs/preview/README.md ../previewkit/docs/cli/
      
      # Remove unnecessary files
      rm -rf ../previewkit/docs/decision_records
      rm -rf ../previewkit/docs/assets

      echo "copying specs..."
      mkdir ../previewkit/docs/spec
      unzip $(System.ArtifactsDirectory)/spec_drop/drop/actions-spec-md.zip -d ../previewkit/docs/spec/
      cp $(System.ArtifactsDirectory)/spec_drop/drop/actions-spec-pdf.zip $(System.ArtifactsDirectory)/release/drop/

      echo "removing arm binary..."
      rm -f $(System.ArtifactsDirectory)/release/drop/*_linux_arm.zip
      
      if [ -d "$(System.ArtifactsDirectory)/cs-sdk/release_drop" ]
      then
        echo "copying nuget pkgs..."
        cp $(System.ArtifactsDirectory)/cs-sdk/release_drop/*.nupkg $(System.ArtifactsDirectory)/release/drop/
      fi
    workingDirectory: '$(Build.SourcesDirectory)'
- task: Bash@3
  displayName: 'Fix url in markdown documents to preview repo url'
  inputs:
    targetType: 'inline'
    script: |
      pushd ../previewkit
      
      find . -name '*.md' -type f -exec sed -i 's/github.com\/actionscore\/actions/github.com\/actionscore\/previewkit/gI' {} \;
      find . -name '*.md' -type f -exec sed -i 's/github.com\/actionscore\/cli\/releases/github.com\/actionscore\/previewkit\/releases/gI' {} \;
      find . -name '*.md' -type f -exec sed -i 's/github.com\/actionscore\/cli\/blob\/master\/README.md/github.com\/actionscore\/previewkit\/blob\/master\/docs\/cli\/README.md/gI' {} \;
      
      popd
    workingDirectory: '$(Build.SourcesDirectory)'
- task: Bash@3
  displayName: 'Git Push the changes to preview Repo'
  inputs:
    targetType: 'inline'
    script: |
      pushd ../previewkit
      
      cd docs/preview/release_notes/
      export LAST_RELEASE_NOTE_FILE=`ls | sort -V | tail -1`
      export LAST_VERSION=`basename $LAST_RELEASE_NOTE_FILE .md`
      echo "##vso[task.setvariable variable=RELEASE_VERSION]$LAST_VERSION"
      cd ../../../

      echo * Latest release version : $LAST_VERSION
  
      git add -A
      git commit -am "Actions Preview Kit $LAST_VERSION"
      git status

      git push origin master

      export LAST_COMMIT=`git rev-parse HEAD`
      echo "##vso[task.setvariable variable=RELEASE_COMMIT]$LAST_COMMIT"

      popd
    workingDirectory: '$(Build.SourcesDirectory)'
- task: GitHubRelease@0
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
  displayName: 'Upload Actions CLI to GitHub Release'  
  inputs:
    gitHubConnection: 'GitHub'
    repositoryName: 'actionscore/previewkit'
    action: 'create'
    target: '$(RELEASE_COMMIT)'
    tagSource: 'manual'
    tag: '$(RELEASE_VERSION)'
    isPreRelease: true
    addChangeLog: false
    releaseNotesFile: './docs/preview/release_notes/$(RELEASE_VERSION).md'
    title: 'Actions Preview Kit $(RELEASE_VERSION)'
    assets: '$(System.ArtifactsDirectory)/release/drop/**'
